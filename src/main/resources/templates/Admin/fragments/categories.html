<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:fragment="categories" class="tab-pane fade" id="categories" role="tabpanel">
    <div class="container-fluid">
        <!-- Toast container -->
        <div class="toast-container"></div>
        
        <!-- Thống kê -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6">
                <div class="card border-left-primary h-100 py-2">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    Tổng danh mục</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${totalCategories}">0</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-folder fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form thêm/sửa danh mục -->
        <div class="card mb-4">
            <div class="card-body">
                <form th:action="@{/admin/danhmuc/api/save}" method="POST" th:object="${danhmuc}">
                    <input type="hidden" th:field="*{maDanhMuc}">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Tên danh mục <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" th:field="*{tenDanhMuc}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Đường dẫn <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" th:field="*{duongDan}" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control" th:field="*{moTa}" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Thứ tự hiển thị</label>
                        <input type="number" class="form-control" th:field="*{thuTuHienThi}">
                    </div>
                    <div class="text-end">
                        <a th:href="@{/admin/danhmuc}" class="btn btn-secondary">
                            <i class="fas fa-redo"></i> Làm mới
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Lưu
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Thêm thông báo success/error -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <!-- Danh sách danh mục -->
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">Danh sách danh mục</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tên danh mục</th>
                                <th>Đường dẫn</th>
                                <th>Thứ tự</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="category : ${danhmucs}">
                                <td th:text="${category.maDanhMuc}"></td>
                                <td th:text="${category.tenDanhMuc}"></td>
                                <td th:text="${category.duongDan}"></td>
                                <td th:text="${category.thuTuHienThi}"></td>
                                <td>
                                    <button type="button" class="btn btn-primary btn-sm" 
                                            th:onclick="'editCategory(' + ${category.maDanhMuc} + ')'">
                                        <i class="fas fa-edit"></i> Sửa
                                    </button>
                                    <button type="button" class="btn btn-danger btn-sm"
                                            th:onclick="'deleteCategory(' + ${category.maDanhMuc} + ')'">
                                        <i class="fas fa-trash"></i> Xóa
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript cho categories -->
<script th:inline="javascript">
    // Hàm cập nhật bảng danh mục
    function updateTable() {
        fetch('/admin/danhmuc/api/list')
            .then(res => res.json())
            .then(data => {
                const tbody = document.querySelector('table tbody');
                tbody.innerHTML = '';
                data.forEach(category => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${category.maDanhMuc}</td>
                            <td>${category.tenDanhMuc}</td>
                            <td>${category.duongDan}</td>
                            <td>${category.thuTuHienThi}</td>
                            <td>
                                <button type="button" class="btn btn-primary btn-sm" 
                                        onclick="editCategory(${category.maDanhMuc})">
                                    <i class="fas fa-edit"></i> Sửa
                                </button>
                                <button type="button" class="btn btn-danger btn-sm"
                                        onclick="deleteCategory(${category.maDanhMuc})">
                                    <i class="fas fa-trash"></i> Xóa
                                </button>
                            </td>
                        </tr>
                    `;
                });
            });
    }

    // Xử lý submit form
    document.querySelector('form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('/admin/danhmuc/api/save', {
            method: 'POST',
            body: formData  // Send FormData directly
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // Hiển thị thông báo thành công
                const alert = document.createElement('div');
                alert.className = 'alert alert-success alert-dismissible fade show';
                alert.innerHTML = `
                    ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.container-fluid').insertBefore(
                    alert, 
                    document.querySelector('.card')
                );
                
                // Reset form
                this.reset();
                
                // Cập nhật bảng
                updateTable();
            } else {
                alert('Lỗi: ' + data.message);
            }
        });
    });

    // Hàm sửa danh mục
    function editCategory(id) {
        window.location.href = '/admin/danhmuc/api?edit=' + id;
    }

    // Hàm xóa danh mục
    function deleteCategory(id) {
        if (confirm('Bạn có chắc muốn xóa danh mục này?')) {
            window.location.href = '/admin/danhmuc/delete/' + id;
        }
    }

    // Hàm reset form
    function resetForm() {
        window.location.href = '/admin/danhmuc/api';
    }
</script>

<style>
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1060;
}

.toast {
    background-color: #fff;
    border-left: 4px solid #28a745;
    box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, .1);
    max-width: 350px;
}

.toast.error {
    border-left-color: #dc3545;
}
</style>

</html>